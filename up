#!/usr/bin/env bash
export SCRIPTPATH
SCRIPTPATH="$( cd "$(dirname "$0")" || exit; pwd -P )"

# [ SETTINGS ]
# Choose a status bar
#   0) eww
#   1) polybar (NOT DONE)
#   2) lemonbar (NOT DONE)
STATUSBAR=1

# [ COLOR SCHEME ]
# Available themes:
#   - amber
#   - dracula
#   - gruvbox
#   - nord
#   - catppuccin
source "$SCRIPTPATH"/scripts/colors.sh dracula

# [ BASICS ]
# Down the last running theme
if [ -f "/tmp/leftwm-theme-down" ]; then
    /tmp/leftwm-theme-down
    rm /tmp/leftwm-theme-down
fi
ln -s "$SCRIPTPATH"/down /tmp/leftwm-theme-down

# Set the theme.toml config
leftwm command "LoadTheme $SCRIPTPATH/theme.toml"

# [ RUN STUFF ]
# picom
if [ -x "$(command -v picom)" ]; then
  picom --config "$HOME"/.config/leftwm/themes/current/conf/picom.config &> /dev/null &
fi

# notifications
if [ -x "$(command -v dunst)" ]; then
  dunst -config "$HOME"/.config/leftwm/themes/current/conf/dunst.config &
fi

nm-applet &

# [ WALLPAPER ]
if [ -x "$(command -v feh)" ]; then
 feh --bg-fill "$SCRIPTPATH"/wallpapers/Artix.png
fi

# [ STATUSBAR ]
case $STATUSBAR in

  0)
    pkill lemonbar &
    pkill polybar &
    pkill eww
    eww -c "$SCRIPTPATH" open bar0
    ;;

  1)
    pkill polybar
    pkill lemonbar &
    pkill eww &
    polybar -c "$SCRIPTPATH"/polybar.config mainbar0 &
    ;;

  2)
    pkill lemonbar &
    pkill polybar &
    pkill eww &
    index=0
    barheight=30
    export TENDERBLOCKS="$SCRIPTPATH/scripts/bartender"
    leftwm-state -q -n -t "$SCRIPTPATH"/sizes.liquid | sed -r '/^\s*$/d' | while read -r width x y
    do
      # 1) Classic/simple mode - lemonbar generated by lemonbar.liquid
      #leftwm-state -w $index -t $SCRIPTPATH/lemonbar.liquid | lemonbar -g "$width"x"$barheight"+"$x" -f "Iosevka Nerd Font"-11 -B$COLOR_BACKGROUND -F$COLOR_FOREGROUND -u 2 -U$COLOR_PRIMARY| sh&
      # 2) Experimental mode - lemonbar generated by a loop in lemonbar.worker
      exec "$HOME"/.config/leftwm/themes/current/lemonbar.worker $index | lemonbar -g "$width"x"$barheight"+"$x" -f "Iosevka Nerd Font"-11 -B"$COLOR_BACKGROUND" -F"$COLOR_FOREGROUND" -u 2 -U"$COLOR_PRIMARY"| sh&

      lemonbar -g "$width"x2+"$x"+$barheight --B"$COLOR_PRIMARY" -p&
      (( index=index+1 ))
    done
    ;;

esac
